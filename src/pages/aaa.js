class DataCalculateStrategyE {
    constructor() {
        this.FREQUENCY = 80_000_000; // 80MHz
        this.LIMIT_DATA = 100_000_000;
        this.COEFFICIENT = 0.035;
        this.SLOPE_ZOOM = 7;
        this.A = -50.719;
        this.B = 1.823;
    }
    
    analyze(data, inhaleCoefficient, exhaleCoefficient) {
        const useData = this.insertZeroBetweenInversionData(this.convertAll(data));
        const result = [];

        let calibratedLps = 0;

        result.push(new FluidMetrics(0, 0, 0));
        for (let i = 1; i < useData.length; i++) {
            const previous = useData[i - 1];
            const current = useData[i];
            const time = this.getTime(current);
            const lps = this.getCalibratedLPS(
                calibratedLps,
                previous,
                current,
                inhaleCoefficient,
                exhaleCoefficient
            );
            calibratedLps = lps;
            const volume = this.getVolume(lps, time);

            const metrics = new FluidMetrics(time, lps, volume);
            metrics.exhale = this.isExhale(current);

            result.push(metrics);
        }

        return result;
    }

    getStrategy() {
        return 'E';
    }

    //완료
    getTime(value) {
        const body = this.getBody(value);
        const time = body * (1 / this.FREQUENCY);

        if (time === 0) return 0;
        return time;
    }

    insertZeroBetweenInversionData(data) {
        const result = [];

        result.push(0);
        data.unshift(0);
        for (let i = 1; i < data.length; i++) {
            const current = data[i];
            let inversion = true;

            if (this.getBody(current) !== 0) {
                for (let j = i - 1; j >= 0; j--) {
                    const past = data[j];

                    if (this.isExhale(past) !== this.isExhale(current)) {
                        break;
                    }

                    if (this.getBody(past) !== 0) {
                        inversion = false;
                        break;
                    }
                }
            }

            if (inversion) {
                result.push(this.getZero(this.isExhale(current)));
            } else {
                result.push(current);
            }
        }

        return result;
    }

    getCalibratedLPS(
        calibratedPreLps,
        previous,
        current,
        inhale,
        exhale
    ) {
        const time = this.getTime(current);
        if (time === 0) return 0;

        const previousLps = this.getLps(previous, inhale, exhale);
        const currentLps = this.getLps(current, inhale, exhale);
        let calibratedLps = 0;

        const slope = (currentLps - previousLps) / time;
        if (slope >= 0) {
            calibratedLps = currentLps;
        } else {
            if (Math.abs(calibratedPreLps) === 0) return 0;
            const predSlope = this.A * Math.pow(currentLps, this.B);
            calibratedLps = currentLps - (currentLps * ((slope / predSlope) * this.SLOPE_ZOOM));
            if (calibratedLps < 0) return 0;
        }
        console.log("aaaa")
        console.log(calibratedLps)
        if (!this.isExhale(current)) return -calibratedLps;
        else return calibratedLps;
    }

    getZero(isExhale) {
        if (isExhale) return 0;
        else return this.LIMIT_DATA;
    }

    getLps(data, inhaleGain, exhaleGain) {

        const time = this.getTime(data);
        if (time === 0) return 0;
        const rps = 1 / time;

        const isExhale = this.isExhale(data);

        if (isExhale) return (rps * this.COEFFICIENT) * exhaleGain;
        else return (rps * this.COEFFICIENT) * inhaleGain;
    }

    getVolume(lps, time) {
        return Math.abs(lps) * time;
    }

    isExhale(data) {
        const head = Math.floor(data / this.LIMIT_DATA);
        return head === 1;
    }

    convert(data) {
        if (data.length === 10) return parseInt(data.substring(0, 9));
        else if (data.length === 9) return parseInt(data);
        else return 0;
    }

    convertAll(allData) {
        const data = allData.split(" ");
        const result = [];

        for (let i = 0; i < data.length; i++) {
            const value = this.convert(data[i]);
            result.push(value);
        }

        return result;
    }

    getHead(data) {
        return Math.floor(data / this.LIMIT_DATA);
    }

    getBody(data) {
        return data % this.LIMIT_DATA;
    }
}

  class FluidMetrics {
    constructor(time, lps, volume) {
        this.time = time;
        this.lps = lps;
        this.volume = volume;
        this.exhale = false;
    }

    setExhale(value) {
        this.exhale = value;
    }
  }

  
  const dataCalculateStrategyE = new DataCalculateStrategyE();

  const data = "051189094 100000000 105156788 103454191 102933040 102739453 102700824 102714417 102744787 102758563 102708975 102657879 102625315 102594377 102563120 102524324 102487741 102452658 102414031 102364680 102303600 102229198 102165904 102128781 102103674 102069091 102045507 102053374 102081678 102125881 102168674 102209604 102259184 102306534 102353163 102383953 102357042 102309097 102266684 102209966 102138998 102073796 102027566 101979363 101916871 101842277 101774152 101727213 101694930 101657644 101616649 101583826 101564872 101554927 101550102 101544306 101541841 101547002 101557000 101572459 101588924 101597934 101609550 101618960 101642664 101672457 101704015 101737768 101762260 101768067 101751864 101717802 101683384 101664621 101659075 101653951 101635416 101609863 101600257 101596890 101589638 101584962 101579792 101596510 101677839 102123326 102694695 103392122 104231436 105246823 106512687 108061659 110080936 112737067 116432118 122225784 134131812 009066170 002339206 001992207 001924457 001976743 002118538 002269155 002264848 002063489 001857111 001740087 001707361 001772400 001910409 002092193 002280590 002434823 002504523 002501889 002448873 002364743 002248037 002107979 001990767 001918648 001866732 001835681 001824968 001832316 001834117 001819031 001812345 001831399 001862389 001887929 001914119 001949350 001982064 002006564 002036715 002070031 002085537 002090612 002106870 002119844 002125997 002143307 002182097 002225925 002263033 002326627 002431527 002521422 002589436 002650777 002660892 002612311 002513820 002366985 002221106 002102416 001986612 001899893 001855295 001832078 001802789 001759393 001734804 001730100 001734135 001733283 001736291 001766051 001824416 001898336 001972016 002050736 002138136 002217042 002287494 002332677 002360655 002381627 002391142 002396727 002444400 002870110 003540227 004333193 005331109 006547103 008113830 010124956 012832594 016688366 126026561 105148819 103127044 102294567 101920977 101733826 101618807 101533770 101444747 101362392 101288839 101230522 101183804 101139857 101099521 101062975 101034327 101006910 100985323 100963610 100946580 100935683 100927630 100919867 100913060 100908928 100909864 100914475 100918016 100920861 100920633 100918620 100915685 100912307 100903545 100894253 100885487 100879260 100874118 100868981 100864759 100862641 100863564 100863123 100860826 100856867 100852443 100850556 100847910 100843057 100838312 100833824 100829943 100826834 100826264 100827288 100825987 100825372 100826289 100826269 100827655 100831860 100840750 100854477 100869467 100882893 100892669 100899827 100910377 100920966 100931484 100938638 100943828 100949775 100957990 100965521 100972489 100979610 100989294 101007529 101036049 101075728 101124918 101184987 101259950 101343127 101427504 101505358 101603524 102194161 102831292 103592808 104494927 105623645 106982359 108656136 110841789 113729562 006611520 001533079 001176185 001029415 000958385 000913153 000879544 000856169 000840491 000826114 000812187 000798438 000784931 000772068 000761109 000750647 000739936 000731593 000723227 000718097 000714697 000712948 000711261 000712100 000715817 000722585 000732204 000744314 000756442 000766919 000775203 000776906 000775249 000769490 000762331 000755343 000749575 000744477 000743915 000745364 000746493 000744775 000742940 000738870 000736716 000736053 000740482 000747584 000757697 000770265 000781543 000790332 000795527 000798595 000799411 000802227 000806273 000811535 000819128 000825962 000832468 000837439 000839723 000838772 000838879 000840576 000847408 000857164 000869529 000884550 000898517 000914331 000927174 000941592 000959908 000981515 001007180 001035281 001064225 001093633 001127252 001163336 001201920 001242736 001290187 001344932 001407323 001477645 001608988 001964613 002403151 002928597 003541927 004310862 005292287 006526519 008097485 010128267 105766011 101643377 101212672 101021464 100892437 100796220 100723797 100668034 100623007 100587155 100557386 100534139 100516142 100500957 100488440 100477731 100468619 100461333 100455035 100449555 100445286 100441375 100438783 100436215 100434897 100433873 100433226 100433301 100433008 100433619 100433702 100434306 100434645 100435098 100436194 100436884 100437155 100438627 100439638 100441079 100442008 100444179 100444876 100445475 100445431 100445527 100444728 100444708 100443223 100443059 100442420 100441342 100441221 100441496 100441373 100442013 100442589 100443188 100443878 100443980 100445326 100447073 100449688 100452523 100455561 100460027 100463626 100467141 100472631 100480842 100491451 100503008 100513785 100524817 100536784 100549260 100559414 100569547 100578381 100584809 100591268 100598238 100604687 100611049 100616375 100623222 100629297 100637362 100652146 100903509 101358392 101936234 102516953 103205714 104009757 104962244 106093109 107578389 109423473 007370769 001118023 000841976 000710714 000632534 000581696 000543535 000516484 000496095 000478280 000461956 000447706 000436628 000427297 000418540 000410501 000404767 000398254 000392242 000387355 000383326 000379404 000375404 000372203 000368312 000364908 000360814 000356931 000353662 000351361 000348911 000346619 000345568 000344650 000344944 000345464 000347319 000349090 000351755 000354403 000357760 000361033 000364702 000368151 000372895 000377944 000383953 000391055 000399069 000408004 000418623 000429790 000442508 000456539 000471691 000488254 000505923 000522580 000538195 000553977 000566185 000576542 000585748 000592536 000599730 000606069 000611708 000616547 000619296 000618861 000616680 000613007 000607330 000603240 000600622 000600642 000602677 000607309 000614439 000622091 000632054 000643069 000655655 000672717 000693464 000718339 000747600 000852980 001084767 001331367 001607417 001945626 002358348 002844274 003438316 004189441 005092141 006249712 007693921 009584402 012096363 015606257 021098855 032346105"; // 여기에 분석할 데이터를 넣으세요
  const inhaleCoefficient = 0; // 흡기 계수
  const exhaleCoefficient = 0; // 호기 계수

  const result = dataCalculateStrategyE.analyze(data, inhaleCoefficient, exhaleCoefficient);

  console.log(result);
